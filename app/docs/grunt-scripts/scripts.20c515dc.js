"use strict";angular.module("stockTrackAngularJsApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","ngMaterial","ngMessages","LocalStorageModule","ngMdIcons"]).config(["$routeProvider","$httpProvider",function(a,b){a.when("/",{templateUrl:"views/routes/main.html",controller:"MainController"}).otherwise({redirectTo:"/"}),b.interceptors.push("LoadingInterceptor")}]).config(["localStorageServiceProvider",function(a){a.setPrefix("staja")}]),angular.module("stockTrackAngularJsApp").controller("MainController",["$scope","$mdSidenav","Constants","User",function(a,b,c,d){a.showWatchlist=!0,a.showPositions=!1,a.init=function(){a.getUser()},a.getUser=function(){d.http.get({},function(b){a.User=new d(b),a.User.initSymbolList().then(function(){a.User.linkPositionSymbols(),a.User.linkWatchlistSymbols(),a.User.selectedSymbol=a.User.WatchList[0].Symbol;var b=c.historicalTabs()[a.User.Preferences.selectedHistoricalIndex||2];a.User.selectedSymbol.getHistoricalData(b.startDate,b.endDate)})})},a.positionsToggle=function(){a.showWatchlist=!1,a.showPositions=!0},a.toggleUserPreferences=function(){b("user-preferences").toggle()},a.watchlistToggle=function(){a.showWatchlist=!0,a.showPositions=!1},a.$on("loader_show",function(){a.isLoading=!0}),a.$on("loader_hide",function(){a.isLoading=!1}),a.init()}]),angular.module("stockTrackAngularJsApp").directive("buyButton",["$window","$filter","$mdDialog",function(a,b,c){return{scope:{symbol:"=",user:"="},templateUrl:"views/directives/buy-button.html",restrict:"E",controller:["$scope",function(d){var e=d;d.buy=function(){if(d.user.availableCash-d.quantity*d.symbol.Ask<0)return a.alert("Sorry, not enough available cash for this transaction."),!1;var e=d.user.Positions.some(function(a){return a.Symbol.Symbol.toLowerCase()===d.symbol.Symbol.toLowerCase()});e?angular.forEach(d.user.Positions,function(a){a.Symbol.Symbol.toLowerCase()===d.symbol.Symbol.toLowerCase()&&a.buys.push({ask:d.symbol.Ask,quantity:d.quantity,created:b("date")(new Date,"medium")})}):d.user.Positions.unshift({Symbol:d.symbol,symbol:d.symbol.Symbol,buys:[{ask:d.symbol.Ask,quantity:d.quantity,created:b("date")(new Date,"medium")}]}),d.user.availableCash=d.user.availableCash-d.quantity*d.symbol.Ask,c.cancel()},d.openBuyModal=function(a){c.show({controller:["$scope",function(a){a.quantity=1,a.symbol=e.symbol,a.user=e.user,a.cancel=function(){c.cancel()},a.buy=e.buy}],templateUrl:"views/directives/modals/buy.html",targetEvent:a})}}]}}]),angular.module("stockTrackAngularJsApp").directive("colorNumber",function(){return{scope:{number:"="},templateUrl:"views/directives/color-number.html",restrict:"E"}}),angular.module("stockTrackAngularJsApp").directive("lineChart",["$window",function(a){return{scope:{historicalData:"="},restrict:"E",link:function(b,c){var d=d3.time.format("%Y-%m-%d").parse,e=function(){if(!b.historicalData)return!1;var a={top:20,right:20,bottom:30,left:50},e=c.parent()[0].offsetWidth-a.left-a.right,f=c.parent()[0].offsetHeight-a.top-a.bottom,g=d3.time.scale().range([0,e]),h=d3.scale.linear().range([f,0]),i=d3.svg.axis().scale(g).orient("bottom"),j=d3.svg.axis().scale(h).orient("left"),k=d3.svg.line().x(function(a){return g(a.date)}).y(function(a){return h(a.close)});d3.select(c[0]).selectAll("*").remove();var l=d3.select(c[0]).append("svg").attr("width",e+a.left+a.right).attr("height",f+a.top+a.bottom).append("g").attr("transform","translate("+a.left+","+a.top+")");b.historicalData.forEach(function(a){a.date=d(a.Date),a.close=+a.Close}),g.domain(d3.extent(b.historicalData,function(a){return a.date})),h.domain(d3.extent(b.historicalData,function(a){return a.close})),l.append("g").attr("class","x axis").attr("transform","translate(0,"+f+")").call(i),l.append("g").attr("class","y axis").call(j).append("text").attr("transform","rotate(-90)").attr("y",6).attr("dy",".71em").style("text-anchor","end").text("Price ($)"),l.append("path").datum(b.historicalData).attr("class","line").attr("d",k)};b.$watch("historicalData",function(){e()},!0),angular.element(a).on("resize",function(){e()})}}}]),angular.module("stockTrackAngularJsApp").directive("positions",["SymbolList",function(a){return{scope:{positions:"="},templateUrl:"views/directives/positions.html",restrict:"E",controller:["$scope",function(b){var c=function(){angular.forEach(b.positions,function(a){var b=0,c=0,d=0;angular.forEach(a.buys,function(e){if(b+=e.quantity,a.Symbol){c=c+a.Symbol.Ask*e.quantity-e.ask*e.quantity;var f=new Date;d=new Date(e.created).setHours(0,0,0,0)===f.setHours(0,0,0,0)?a.Symbol.Ask*b-e.ask*b:a.Symbol.Ask*b-a.Symbol.PreviousClose*b}}),a.totalQuantity=b,a.totalPNL=c,a.dailyPNL=d,a.totalValue=a.Symbol?a.Symbol.Ask*b:0})};b.refreshSymbols=function(){a.refreshSymbols()},b.$watch("positions",function(){b.positions&&c()},!0)}]}}]),angular.module("stockTrackAngularJsApp").directive("sellButton",function(){return{scope:{symbol:"=",user:"="},templateUrl:"views/directives/sell-button.html",restrict:"E",controller:["$scope","$log",function(a,b){a.openSellModal=function(a){b.debug("sell",a)}}]}}),angular.module("stockTrackAngularJsApp").directive("sparkLine",function(){return{scope:{askHistory:"="},template:'<div class="spark-line"></div>',restrict:"E",link:function(a,b){var c,d,e,f,g,h=b.parent().prop("offsetWidth"),i=40,j=function(a){b.find("div").empty(),c=d3.select(b[0].querySelector(".spark-line")).append("svg:svg").attr("width","100%").attr("height","40px").attr("style","padding-top:9px"),d=a,f=d3.scale.linear().domain([0,a.length]).range([0,h]),g=d3.scale.linear().domain([d3.min(a),d3.max(a)]).range([0,i-15]),e=d3.svg.line().x(function(a,b){return f(b)}).y(function(a){return g(a)}),c.append("svg:path").attr("d",e(d))};a.$watch("askHistory",function(){a.askHistory&&a.askHistory.length&&j(a.askHistory)},!0)}}}),angular.module("stockTrackAngularJsApp").directive("userPreferences",["$interval","SymbolList",function(a,b){return{scope:{user:"="},templateUrl:"views/directives/user-preferences.html",restrict:"E",controller:["$scope",function(c){c.symbolRefreshChange=function(){a.cancel(b.interval),c.user.Preferences.refreshState&&(b.interval=a(function(){b.refreshSymbols()},c.user.Preferences.refreshRate))}}]}}]),angular.module("stockTrackAngularJsApp").directive("userTotals",function(){return{scope:{user:"="},templateUrl:"views/directives/user-totals.html",restrict:"E",controller:["$scope",function(a){var b=function(){var b=0,c=0,d=0;angular.forEach(a.user.Positions,function(a){c+=a.totalPNL,b+=a.dailyPNL,d+=a.totalValue}),a.dailyPNL=b,a.totalPNL=c,a.totalValue=d};a.$watch("user.Positions",function(){a.user&&a.user.Positions&&b()},!0)}]}}),angular.module("stockTrackAngularJsApp").directive("watchListDetails",["$mdDialog","SymbolList","$mdSidenav","Constants",function(a,b,c,d){return{restrict:"E",scope:{symbol:"=",user:"="},templateUrl:"views/directives/watch-list-details.html",controller:["$scope",function(e){e.Constants=d,e.removeFromWatchlist=function(c,d){var f=a.confirm().parent(angular.element(document.body)).title("Remove from watch list").content("Would you like to remove "+c.Symbol+" from your watch list?").ariaLabel("Remove from watchlist?").ok("Remove").cancel("Keep").targetEvent(d);a.show(f).then(function(){b.removeSymbol(c);var a=e.user.WatchList.map(function(a){return a.Symbol}).indexOf(c);e.user.WatchList.splice(a,1),e.user.selectedSymbol=e.user.WatchList[0].Symbol})},e.toggleWatchlist=function(){c("watch-list").toggle()}}]}}]),angular.module("stockTrackAngularJsApp").directive("watchList",["Symbol","Constants","localStorageService","$mdSidenav","SymbolList",function(a,b,c,d,e){return{scope:{watchList:"=",preferences:"=",selectedSymbol:"="},templateUrl:"views/directives/watch-list.html",restrict:"E",controller:["$scope",function(b){b.closeWatchlist=function(){d("watch-list").close()},b.search=function(b){return b&&b.length>0?a.http.search({searchVal:b}).$promise.then(function(a){var b=a.query.results.quote;return b.value=b.Name,b.display=b.Name,a.query.results.quote.Ask?[b]:[]}):[]},b.refreshSymbols=function(){e.refreshSymbols()},b.chooseSymbol=function(a){if(a){if(b.searchText="",b.watchList.some(function(b){return b.symbol.toLowerCase()===a.symbol.toLowerCase()}))return!1;b.watchList.unshift({symbol:a.symbol,Symbol:e.addSymbol(a)}),b.selectSymbol(b.watchList[0].Symbol)}},b.selectSymbol=function(a){b.selectedSymbol=a}}]}}]),angular.module("stockTrackAngularJsApp").factory("Constants",function(){var a={};return a.getDate=function(a){var b=a.getDate(),c=a.getMonth()+1,d=a.getFullYear();return 10>b&&(b="0"+b),10>c&&(c="0"+c),d+"-"+c+"-"+b},a.fiveDaysFromtoday=new Date((new Date).setDate((new Date).getDate()-5)),a.oneMonthFromtoday=new Date((new Date).setMonth((new Date).getMonth()-1)),a.oneYearFromtoday=new Date((new Date).setFullYear((new Date).getFullYear()-1)),a.sixMonthsFromtoday=new Date((new Date).setMonth((new Date).getMonth()-6)),a.threeMonthsFromtoday=new Date((new Date).setMonth((new Date).getMonth()-3)),a.today=new Date,a.historicalTabs=function(){return[{title:"5 Day",slug:"5-day",endDate:a.getDate(a.today),startDate:a.getDate(a.fiveDaysFromtoday)},{title:"1 Month",slug:"1-month",endDate:a.getDate(a.today),startDate:a.getDate(a.oneMonthFromtoday)},{title:"3 Month",slug:"3-month",endDate:a.getDate(a.today),startDate:a.getDate(a.threeMonthsFromtoday)},{title:"6 Month",slug:"6-month",endDate:a.getDate(a.today),startDate:a.getDate(a.sixMonthsFromtoday)},{title:"1 Year",slug:"1-year",endDate:a.getDate(a.today),startDate:a.getDate(a.oneYearFromtoday)}]},a}),angular.module("stockTrackAngularJsApp").factory("LoadingInterceptor",["$rootScope","$q",function(a,b){var c=0;return{request:function(d){return c++,a.$broadcast("loader_show"),d||b.when(d)},response:function(d){return--c,0===c&&a.$broadcast("loader_hide"),d||b.when(d)},responseError:function(d){return--c,0===c&&a.$broadcast("loader_hide"),b.reject(d)}}}]),angular.module("stockTrackAngularJsApp").factory("Position",function(){var a=function(a){var b=this;Object.keys(a).forEach(function(c){b[c]=a[c]})};return a}),angular.module("stockTrackAngularJsApp").factory("SymbolList",["Symbol","$interval","$filter","$log",function(a,b,c,d){return{Symbols:[],WatchList:[],Positions:[],Preferences:{},addSymbol:function(b){var c=this.Symbols.filter(function(a){return a.Symbol.toLowerCase()===b.Symbol.toLowerCase()});if(c.length>0)return c[0];var d=a,e=new d(b);return this.Symbols.push(e),e},init:function(b,c,d){var e=this;this.WatchList=b,this.Positions=c,this.Preferences=d;var f=b.map(function(a){return a.symbol.toLowerCase()}),g=c.map(function(a){return a.symbol.toLowerCase()}),h=f.concat(g.filter(function(a){return f.indexOf(a)<0}));return a.http.all({list:h}).$promise.then(function(a){return e.setInitialSymbols(a)})},refreshSymbols:function(){var b=this;a.http.all({list:this.Symbols.map(function(a){return a.symbol.toLowerCase()})}).$promise.then(function(a){a.query.results&&angular.forEach(a.query.results.quote,function(a,c){b.Symbols[c].askHistory.length>50&&b.Symbols[c].askHistory.shift(),b.Symbols[c].askHistory.push(a.Ask),Object.keys(a).forEach(function(d){b.Symbols[c][d]=a[d]})})}),d.debug("Refreshing Symbols: "+c("date")(new Date,"medium"))},removeSymbol:function(a){var b=this.Positions.some(function(b){return a.symbol.toLowerCase()===b.symbol.toLowerCase()});return b||this.Symbols.splice(this.Symbols.indexOf(a),1),this.Symbols},setInitialSymbols:function(c){var d=[];return c&&c.query&&c.query.results&&(angular.forEach(c.query.results.quote,function(b){var c=a,e=new c(b);e.askHistory.push(b.Ask),d.push(e)}),this.Preferences.refreshState&&(this.interval=b(function(){this.refreshSymbols()},this.Preferences.refreshRate))),this.Symbols=d,this.Symbols}}}]),angular.module("stockTrackAngularJsApp").factory("Symbol",["$resource",function(a){var b=function(a){var b=this;Object.keys(a).forEach(function(c){b[c]=a[c]}),this.askHistory=[]};return b.prototype.getHistoricalData=function(a,b){var c=this;this.http.details({symbol:this.Symbol,startDate:a,endDate:b}).$promise.then(function(a){c.historicalData=a.query.results.quote})},b.http=a("http://query.yahooapis.com/v1/public/yql",{},{search:{method:"GET",url:'http://query.yahooapis.com/v1/public/yql?q=select * from yahoo.finance.quotes where symbol in (":searchVal")',params:{format:"json",env:"store://datatables.org/alltableswithkeys"}},all:{method:"GET",url:'http://query.yahooapis.com/v1/public/yql?q=select * from yahoo.finance.quotes where symbol in (":list")',params:{format:"json",env:"store://datatables.org/alltableswithkeys"}}}),b.prototype.http=a("http://query.yahooapis.com/v1/public/yql",{},{details:{method:"GET",url:'http://query.yahooapis.com/v1/public/yql?q=select * from yahoo.finance.historicaldata where symbol = ":symbol" and startDate = ":startDate" and endDate = ":endDate"',params:{format:"json",env:"store://datatables.org/alltableswithkeys"}}}),b}]),angular.module("stockTrackAngularJsApp").factory("User",["$resource","Constants","Symbol","SymbolList",function(a,b,c,d){var e=function(a){var b=this;Object.keys(a).forEach(function(c){b[c]=a[c]})};return e.http=a("json/user.json/:id",{id:"@id"},{get:{method:"GET"}}),e.prototype.initSymbolList=function(){return d.init(this.WatchList,this.Positions,this.Preferences)},e.prototype.linkPositionSymbols=function(){var a=d.Symbols;angular.forEach(this.Positions,function(b){angular.forEach(a,function(a){a.symbol.toLowerCase()===b.symbol.toLowerCase()&&(b.Symbol=a)})})},e.prototype.linkWatchlistSymbols=function(){var a=d.Symbols;angular.forEach(this.WatchList,function(b){angular.forEach(a,function(a){a.symbol.toLowerCase()===b.symbol.toLowerCase()&&(b.Symbol=a)})})},e}]);